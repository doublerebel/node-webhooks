#!/usr/bin/env node
'use strict'

var app      = require('../'),
    optparse = require("iced-coffee-script/lib/coffee-script/optparse"),
    BANNER,
    SWITCHES,
    optionParser,
    opts,
    usage;

// The help banner that is printed in conjunction with `-h`/`--help`.
BANNER = [
  "",
  "Usage: webhooks [start|hash] [options]",
  "Starts a webhook listener server that runs a node or shell script in the",
  "local directory.",
  ""].join("\n");

// The list of all the valid option flags that `coffee` knows how to handle.
SWITCHES = [
  ['-k', '--secret [SECRET]',          'secret for URL hash (default: "' + app.secret + '")'],
  ['-n', '--namespace [NAMESPACE]',       'namespace for URL hash (default: none)'],
  ['-p', '--port [PORT]',            'port for webhook listener (default: ' + app.port + ')'],
  ['-s', '--script [SCRIPT]',          'filename of local script (default: ' + app.script + ')'],
  ['-t', '--type [TYPE]',            'type of local script (node or shell) (default: ' + app.type + ')']
];

optionParser  = new optparse.OptionParser(SWITCHES, BANNER);
opts          = optionParser.parse(process.argv.slice(3));


switch (process.argv[2]) {
	case "start":
  		for (var key in opts) {
  			if (key === "arguments") continue;
  			if (opts[key]) app[key] = opts[key];
  		}

  		console.info("Listening on :" + app.port);
  		app.listen(app.port);
  		break;

  	case "hash":
		console.info(app.hashCwd());
		break;

  	default:
  		console.log(optionParser.help());
		break;
}

